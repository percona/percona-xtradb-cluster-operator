#!/bin/bash

set -o errexit

test_dir=$(realpath $(dirname $0))
. ${test_dir}/../functions

set_debug

create_infra $namespace

desc 'create PXC cluster'

cluster="some-name"
spinup_pxc "$cluster" "$conf_dir/$cluster.yml"

desc 'check user created on cluster creation'
# compare_mysql_cmd "select-1" "SELECT 1;" "-h $cluster-proxysql -uroot -p'$newpass'"
compare_mysql_cmd "select-1" "SELECT 1;" "-h $cluster-proxysql -uroot -ptestpass"

desc 'delete initial users from CR and create a new one'
kubectl_bin patch pxc some-name --type=merge -p='{"spec":{"proxysql":{"size":3}}}'
wait_cluster_consistency "$cluster" 3 3

desc 'check password change'
newpass="test-password"
newpassencrypted=$(echo -n "$newpass" | base64)

patch_secret "user-one" "userOnePassKey" "$newpassencrypted"
sleep 15

desc 'check user grants update from CR'

desc 'check user grants update from DB'

desc 'check user recreated after deleted from DB'

desc 'check new user created after updated user name via CR'

desc 'check new user created with default db and secret password key'


destroy "${namespace}"
desc "test passed"
