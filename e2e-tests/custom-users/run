#!/bin/bash

set -o errexit

test_dir=$(realpath $(dirname $0))
. ${test_dir}/../functions

set_debug

create_infra $namespace

desc 'create PXC cluster'

cluster="some-name"
kubectl_bin apply -f "$test_dir/conf/user-secrets.yml"
spinup_pxc "$cluster" "$test_dir/conf/$cluster.yml"

desc 'check users created on cluster creation'
compare_mysql_user "-h $cluster-haproxy -uuser-one -ptestpass"
compare_mysql_cmd "select-2" "SELECT User, Host from mysql.user WHERE User = 'user-one';" "-h $cluster-haproxy -uroot -proot_password"
compare_mysql_cmd "select-3" "SHOW GRANTS FOR 'user-one'@'%';" "-h $cluster-haproxy -uroot -proot_password"
compare_mysql_cmd "select-4" "SHOW GRANTS FOR 'user-one'@'localhost';" "-h $cluster-haproxy -uroot -proot_password"

	# local ownerName=$(kubectl_bin get secrets/$cluster-ssl -o json | jq '.metadata.ownerReferences[0].name')
generatedUserSecret=$(echo "$cluster-custom-user-secret")
generatedPass=$(kubectl_bin get secret $generatedUserSecret -n $namespace  -o jsonpath="{.data.my-user-pwd-key}" | base64 -d 1>/dev/null 2>/dev/null)
compare_mysql_user "-h $cluster-haproxy -uuser-two -p'$generatedPass'"
compare_mysql_cmd "select-5" "SELECT User, Host from mysql.user WHERE User = 'user-two';" "-h $cluster-proxysql -uroot -proot_password"

desc 'delete initial users from CR and create a new one'
kubectl_bin patch pxc some-name --type=merge -p='{
		"spec": {"users":[
			{
				"name":"user-three",
				"grants":["SELECT, REPLICATION_SLAVE, REPLICATION_CLIENT"],
				"passwordSecretRef": {
					"name": "user-secrets-one",
					"key": "pwd-key"
				},
				"hosts": ["%"] 
			}
		]}
	}'
wait_cluster_consistency "$cluster" 3 3

compare_mysql_user "-h $cluster-haproxy -uuser-three -ptestpass"
compare_mysql_cmd "select-6" "SELECT User, Host from mysql.user WHERE User = 'user-one';" "-h $cluster-haproxy -uroot -proot_password"

# user-one and user-two should not be deleted
compare_mysql_user "-h $cluster-haproxy -uuser-one -ptestpass"
compare_mysql_user "-h $cluster-haproxy -uuser-two -p'$generatedPass'"

desc 'check password change'
newpass="test-password"
newpassencrypted=$(echo -n "$newpass" | base64)

patch_secret "user-secrets-one" "pwd-key" "$newpassencrypted"
sleep 15

compare_mysql_user "-h $cluster-haproxy -uuser-three -p'$newpass'"


desc 'check user grants update from CR'

desc 'check user grants update from DB'

desc 'check user recreated after deleted from DB'

desc 'check new user created after updated user name via CR'

desc 'check new user created with default db and secret password key'


destroy "${namespace}"
desc "test passed"
