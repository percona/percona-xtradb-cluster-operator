#!/bin/bash

set -o errexit

test_dir=$(realpath $(dirname $0))
. ${test_dir}/../functions

set_debug

cluster="some-name"

function compare_scheduler() {
	local pod=$1
	local compare_file=$2

	compare_mysql_cmd_local ${compare_file} \
		'SELECT * FROM runtime_scheduler;' \
		"-h127.0.0.1 -P6032 -uproxyadmin -padmin_password" \
		${pod}
}

function compare_mysql_servers() {
	local pod=$1
	local compare_file=$2

	compare_mysql_cmd_local ${compare_file} \
		'SELECT hostgroup_id,SUBSTRING(hostname, 0, 16),weight,status FROM runtime_mysql_servers WHERE status='\'ONLINE\''' \
		"-h127.0.0.1 -P6032 -uproxyadmin -padmin_password" \
		${pod}
}

create_infra ${namespace}

desc "create PXC cluster: ${cluster}"
spinup_pxc "${cluster}" "${test_dir}/conf/${cluster}.yml"
wait_cluster_consistency "${cluster}" 3 2

desc 'check if service and statefulset created with expected config'
compare_kubectl statefulset/${cluster}-pxc
compare_kubectl statefulset/${cluster}-proxysql
compare_kubectl service/${cluster}-pxc
compare_kubectl service/${cluster}-proxysql
compare_kubectl service/${cluster}-proxysql-unready

# give some time for mysql_servers to be populated
# this won't be needed once we add probes to ProxySQL containers
sleep 120

desc 'check if scheduler is enabled in all ProxySQL servers'

compare_scheduler "${cluster}-proxysql-0" "scheduler-0"
log "scheduler is enabled in ${cluster}-proxysql-0: OK"
compare_scheduler "${cluster}-proxysql-1" "scheduler-1"
log "scheduler is enabled in ${cluster}-proxysql-1: OK"

desc 'check if scheduler is doing its job in all ProxySQL servers'

compare_mysql_servers "${cluster}-proxysql-0" "mysql-servers-0"
log "mysql_servers are configured in ${cluster}-proxysql-0: OK"
compare_mysql_servers "${cluster}-proxysql-1" "mysql-servers-1"
log "mysql_servers are configured in ${cluster}-proxysql-1: OK"

desc 'check scaling PXC up'
kubectl_bin patch pxc ${cluster} --type=merge -p '{"spec": {"pxc": {"size": 5}}}'
wait_pod ${cluster}-pxc-3
wait_pod ${cluster}-pxc-4

# give some time for mysql_servers to be populated
# this won't be needed once we add probes to ProxySQL containers
sleep 120

compare_mysql_servers "${cluster}-proxysql-0" "mysql-servers-0-1"
log "new mysql_servers are configured in ${cluster}-proxysql-0: OK"
compare_mysql_servers "${cluster}-proxysql-1" "mysql-servers-1-1"
log "new mysql_servers are configured in ${cluster}-proxysql-1: OK"

desc 'check scaling ProxySQL up'
kubectl_bin patch pxc ${cluster} --type=merge -p '{"spec": {"proxysql": {"size": 3}}}'
wait_pod ${cluster}-proxysql-2

# give some time for mysql_servers to be populated
# this won't be needed once we add probes to ProxySQL containers
sleep 120

compare_scheduler "${cluster}-proxysql-2" "scheduler-2"
log "scheduler is enabled in ${cluster}-proxysql-2: OK"

compare_mysql_servers "${cluster}-proxysql-2" "mysql-servers-2"
log "mysql_servers are configured in ${cluster}-proxysql-2: OK"

desc "test passed"

destroy ${namespace}
